!function (a, b) {
    "function" == typeof define && define.amd ? define(["google", "angular", "geoXML3"], function (a, c, d) {
        return b(a, c, d)
    }) : "object" == typeof exports ? module.exports = b(require("google"), require("angular"), require("geoXML3")) : b(google, angular, geoXML3)
}(this, function (a, b, c) {
    !function (a) {
        "use strict";
        a.module("LogicifyGMap", [])
    }(b), function (a) {
        "use strict";
        a.module("LogicifyGMap").service("SmartCollection", [function () {
            function a(a) {
                var c = this;
                Array.isArray(a) && a.forEach(function (a, b) {
                    c.push(a)
                }), c._uid = b++;
                var d = [], e = [], f = c.push;
                c.push = function () {
                    var a = Array.prototype.slice.call(arguments), b = f.apply(c, a);
                    return a.forEach(function (a) {
                        d.forEach(function (b) {
                            b.apply(c, [a])
                        })
                    }), b
                };
                var g = c.pop;
                c.pop = function () {
                    var a = Array.prototype.slice.call(arguments), b = g.apply(c, a);
                    return e.forEach(function (a) {
                        a.apply(c, [b])
                    }), b
                };
                var h = c.unshift;
                c.unshift = function () {
                    var a = Array.prototype.slice.call(arguments), b = h.apply(c, a);
                    return a.forEach(function (a) {
                        d.forEach(function (b) {
                            b.apply(c, [a])
                        })
                    }), b
                };
                c.shift;
                c.shift = function () {
                    var a = Array.prototype.slice.call(arguments), b = h.apply(c, a);
                    return e.forEach(function (a) {
                        a.apply(c, [b])
                    }), b
                };
                var i = c.splice;
                c.splice = function () {
                    var a = Array.prototype.slice.call(arguments), b = i.apply(c, a);
                    return b.forEach(function (a) {
                        e.forEach(function (b) {
                            b.apply(c, [a])
                        })
                    }), b
                }, c.removeQuietly = i, c.onRemoveItem = function (a) {
                    "function" == typeof a && e.push(a)
                }, c.onAddItem = function (a) {
                    "function" == typeof a && d.push(a)
                }
            }

            var b = 0;
            return a.prototype = Object.create(Array.prototype), a.prototype.constructor = a, a
        }])
    }(b), function (a, b) {
        "use strict";
        b.module("LogicifyGMap").directive("logicifyGmapControl", ["$compile", "$log", "$timeout", function (c, d, e) {
            return {
                restrict: "E", require: "^logicifyGmap", link: function (d, f, g, h) {
                    function i(b, c) {
                        return a.maps.event.addDomListener(m[0], b, function () {
                            var a = arguments, b = this;
                            e(function () {
                                c.apply(b, a)
                            })
                        })
                    }

                    var j = d.$eval(g.controlPosition), k = d.$eval(g.controlIndex), l = d.$eval(g.events), m = b.element(f.html().trim()), n = [];
                    c(m)(d), e(function () {
                        d.$apply()
                    }), d.$on("$destroy", function () {
                        n.forEach(function (b) {
                            a && a.maps && a.maps.event.removeListener(b)
                        })
                    }), m[0].index = k || 0, f.html("");
                    var o = h.getMap();
                    if (!o.controls[j])throw new Error("Position of control on the map is invalid. Please see google maps spec.");
                    o.controls[j].push(m[0]), null != l && b.forEach(l, function (a, b) {
                        "function" == typeof a && n.push(i(b, a))
                    })
                }
            }
        }])
    }(a, b), function (a, b) {
        "use strict";
        b.module("LogicifyGMap").directive("logicifyGmap", ["$compile", "$log", "$timeout", function (c, d, e) {
            return {
                restrict: "E",
                scope: {gmOptions: "&gmOptions", gmReady: "&gmReady", cssOptions: "&cssOptions"},
                controller: function (d, f, g) {
                    var h = this, i = d.gmOptions(), j = d.gmReady(), k = {
                        zoom: 8,
                        center: new a.maps.LatLng(-34.397, 150.644)
                    }, l = d.cssOptions();
                    i = i || {};
                    var m = {height: "100%", width: "100%", position: "absolute"};
                    b.extend(m, l), b.extend(k, i), f.css(m);
                    var n = b.element("<div>");
                    n.css({height: "100%", width: "100%", margin: 0, padding: 0}), f.append(n);
                    var o = new a.maps.Map(n[0], k);
                    return h.getMap = function () {
                        return o
                    }, "function" == typeof j && j(o), o.openInfoWnd = function (a, b, f, g, h) {
                        if (h.apply(g, [b, f]), g.$scope && g.$compiled)e(function () {
                            g.$scope.$apply()
                        }); else {
                            var i = d.$new();
                            i.$infoWND = g, g.$scope = i, e(function () {
                                i.$apply()
                            })
                        }
                        if (g.$compiled !== !0) {
                            var j = c(a.trim())(g.$scope);
                            g.$compiled = !0, g.setContent(j[0])
                        }
                    }, o.closeInfoWnd = function (a, b) {
                        a.$scope && (a.$compiled = !1, a.$scope.$destroy(), delete a.$scope, delete a.$compiled), b.apply(a, [])
                    }, h
                }
            }
        }])
    }(a, b), function (a, b) {
        "use strict";
        b.module("LogicifyGMap").directive("xmlOverlays", ["$timeout", "$log", "$q", "$compile", "$http", "SmartCollection", function (d, e, f, g, h, i) {
            return {
                restrict: "E", require: "^logicifyGmap", link: function (g, j, k, l) {
                    function m(a, c) {
                        var d = {};
                        return b.extend(d, g.parserOptions), d.map = a, d.afterParse = q, d.onAfterCreateGroundOverlay = g.events.onAfterCreateGroundOverlay, d.onAfterCreatePolygon = g.events.onAfterCreatePolygon, d.onAfterCreatePolyLine = g.events.onAfterCreatePolyLine, d.failedParse = r, d.infoWindow = c, d
                    }

                    function n() {
                        return g.$watch("kmlCollection._uid", function (a, b) {
                            (null == a || a != A) && (g.kmlCollection instanceof i || (g.kmlCollection = new i(g.$eval(k.kmlCollection))), A = g.kmlCollection._uid, (g.busy === !0 || z.docs && z.docs.length > 0) && (B.forEach(function (a) {
                                a._abort()
                            }), B.splice(0, B.length), t()), u().then(function () {
                                B.splice(0, B.length)
                            }))
                        })
                    }

                    function o(a) {
                        null != a && x(a).then(function (a) {
                            1 != g.kmlCollection.length && g.fitBoundsAfterAll !== !1 && (g.globalBounds.extend(a.doc[0].bounds.getCenter()), d(function () {
                                g.gMap.fitBounds(g.globalBounds)
                            }, 10))
                        })
                    }

                    function p(a) {
                        t(a)
                    }

                    function q(a, b) {
                        a[0].$uid = (new Date).getTime() + "-index-" + Math.floor(-9 * Math.random()), "function" == typeof g.events.onAfterParse && g.events.onAfterParse(a), b && b.resolve(a)
                    }

                    function r(a, b) {
                        b && b.reject(a), "function" == typeof g.events.onAfterParseFailed && g.events.onAfterParseFailed(a)
                    }

                    function s() {
                        g.globalBounds = new a.maps.LatLngBounds, 1 != g.kmlCollection.length && g.fitBoundsAfterAll !== !1 ? (g.kmlCollection.forEach(function (a) {
                            g.globalBounds.extend(a.doc[0].bounds.getCenter())
                        }), d(function () {
                            g.gMap.fitBounds(g.globalBounds)
                        }, 10)) : g.kmlCollection.length > 0 && g.fitBoundsAfterAll !== !1 && d(function () {
                            g.gMap.fitBounds(g.kmlCollection[0].doc[0].bounds)
                        }, 10)
                    }

                    function t(c) {
                        if (c) {
                            z.hideDocument(c.doc[0]);
                            var d = z.docs.indexOf(c.doc[0]);
                            d > -1 && (delete z.docsByUrl[c.doc[0].baseUrl], z.docs.splice(d, 1), s())
                        } else b.forEach(z.docs, function (a) {
                            z.hideDocument(a)
                        }), z.docs.splice(0, z.docs.length), z.docsByUrl = {}, g.globalBounds = new a.maps.LatLngBounds
                    }

                    function u() {
                        return g.kmlCollection instanceof i ? (g.busy = !0, g.kmlCollection.onAddItem(o), g.kmlCollection.onRemoveItem(p), g.kmlCollection.forEach(function (a) {
                            B.push(x(a))
                        }), f.all(B).then(function (a) {
                            s(), B.splice(0, B.length), g.busy = !1
                        })) : void 0
                    }

                    function v() {
                        "function" == typeof g.onProgress && g.onProgress({
                            total: B.length,
                            done: w(C.RESOLVED),
                            errors: w(C.REJECTED)
                        })
                    }

                    function w(a) {
                        var b = 0;
                        return B.forEach(function (c) {
                            c.$$state.status === a && b++
                        }), b
                    }

                    function x(a) {
                        var b = f.defer(), c = f.defer();
                        b.promise._abort = function () {
                            b.reject(), c.resolve()
                        }, null != a.url ? h.get(a.url, {
                            timeout: c.promise,
                            responseType: "arraybuffer"
                        }).then(function (a) {
                            var c = new Blob([a.data], {type: a.headers()["content-type"]});
                            c.lastModifiedDate = new Date, c.name = "example" + c.lastModifiedDate, y(c, null, b)
                        }) : "String" == typeof a.content ? y(null, a.content, b) : a.file instanceof Blob ? y(a.file, null, b) : e.error("Incorrect file type. Should be an instance of a Blob or String (url).");
                        var d = b.promise.then(function (b) {
                            return a.doc = b, a
                        })["catch"](function (a) {
                        })["finally"](function () {
                            v()
                        });
                        return d
                    }

                    function y(a, b, c) {
                        null == b ? z.parse(a, null, c) : z.parseKmlString(b, null, c)
                    }

                    var z = null;
                    g.kmlCollection = new i(g.$eval(k.kmlCollection));
                    var A = g.kmlCollection._uid;
                    g.events = g.$eval(k.gmapEvents) || {}, g.parserOptions = g.$eval(k.parserOptions) || {}, g.onProgress = g.$eval(k.onProgress), g.fitBoundsAfterAll = g.$eval(k.fitAllLayers);
                    var B = [], C = {PENDING: 0, RESOLVED: 1, REJECTED: 2};
                    g.gMap = l.getMap(), g.infowindow = g.$eval(k.infoWindow), g.collectionsWatcher = n(), g.infowindow && "function" == typeof g.infowindow.$ready ? g.infowindow.$ready(function (a) {
                        z = new c.parser(m(g.gMap, a)), u()
                    }) : (z = new c.parser(m(map)), u()), g.$on("$destroy", function () {
                        "function" == typeof g.collectionsWatcher && g.collectionsWatcher(), B.forEach(function (a) {
                            a._abort()
                        })
                    })
                }
            }
        }])
    }(a, b), function (a, b) {
        b.module("LogicifyGMap").service("InfoWindow", ["$log", "$rootScope", "$templateCache", "$timeout", "$http", "$compile", function (b, c, d, e, f, g) {
            function h() {
                function b(a) {
                    var b = c.open;
                    c.open = function (d, e) {
                        h = d, "function" == typeof d.openInfoWnd && d.openInfoWnd(a, d, e, c, b)
                    };
                    var d = c.close;
                    if (c.close = function (a) {
                            h && ("function" == typeof h.closeInfoWnd && a === !0 ? h.closeInfoWnd(c, d) : d.apply(c, []))
                        }, g = !0, e.length > 0) {
                        for (var f = 0; f < e.length; f++)e[f](c);
                        e = []
                    }
                }

                var c = this, e = [], g = !1, h = null;
                c.$ready = function (a) {
                    return g === !0 && a ? void a(c) : void(a && e.push(a))
                }, arguments[0] ? arguments[0].templateUrl ? f.get(arguments[0].templateUrl, {cache: d}).then(function (d) {
                    arguments[0].content = d.data, a.maps.InfoWindow.apply(c, arguments), b(d.data)
                }) : arguments[0].content && (a.maps.InfoWindow.apply(c, arguments), b(arguments[0].content)) : a.maps.InfoWindow.apply(c, arguments)
            }

            return a && (h.prototype = Object.create(a.maps.InfoWindow.prototype), h.prototype.constructor = h), h
        }])
    }(a, b)
});